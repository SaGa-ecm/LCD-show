#!/bin/bash

# LCD35-show für DietPi auf Raspberry Pi Zero 2 W
# Angepasst von dem Original-Script von goodtft/LCD-show

# Systembackup erstellen
echo "Erstelle Systembackup..."
if [ -f ./system_backup.sh ]; then
    sudo ./system_backup.sh
else
    echo "Warnung: system_backup.sh nicht gefunden, überspringe Backup"
fi

# Entferne alte Konfigurationen
if [ -f /etc/X11/xorg.conf.d/40-libinput.conf ]; then
    sudo rm -rf /etc/X11/xorg.conf.d/40-libinput.conf
fi

# Erstelle Verzeichnis falls nicht vorhanden
if [ ! -d /etc/X11/xorg.conf.d ]; then
    sudo mkdir -p /etc/X11/xorg.conf.d
fi

# Kopiere Overlay-Dateien
echo "Kopiere Overlay-Dateien..."
sudo cp ./usr/tft35a-overlay.dtb /boot/overlays/
sudo cp ./usr/tft35a-overlay.dtb /boot/overlays/tft35a.dtbo

# Lade Systemkonfiguration
if [ -f ./system_config.sh ]; then
    source ./system_config.sh
else
    echo "Warnung: system_config.sh nicht gefunden"
fi

# Erstelle config.txt Backup
sudo cp -rf /boot/config.txt /boot/config.txt.bak

# Konfiguriere config.txt für DietPi
echo "Konfiguriere config.txt für DietPi mit 3,5-Zoll-LCD..."
sudo tee -a /boot/config.txt > /dev/null << EOF

# LCD Display Konfiguration
hdmi_force_hotplug=1
dtparam=i2c_arm=on
dtparam=spi=on
enable_uart=1
dtoverlay=tft35a:rotate=90
hdmi_group=2
hdmi_mode=1
hdmi_mode=87
hdmi_cvt 480 320 60 6 0 0 0
hdmi_drive=2
EOF

# Kopiere Kalibrierungsdatei
echo "Kopiere Kalibrierungsdatei..."
sudo cp -rf ./usr/99-calibration.conf-35-90 /etc/X11/xorg.conf.d/99-calibration.conf

# Prüfe DietPi-Version und kopiere fbturbo.conf wenn nötig
dietpi_version=$(cat /etc/dietpi/dietpi/.version 2>/dev/null || echo "0")
if [[ "$dietpi_version" < "12.1" ]]; then
    echo "Kopiere fbturbo.conf für ältere DietPi-Version..."
    sudo cp -rf ./usr/99-fbturbo.conf /usr/share/X11/xorg.conf.d/99-fbturbo.conf
fi

# Kopiere inittab
sudo cp ./usr/inittab /etc/ 2>/dev/null || echo "Warnung: inittab nicht gefunden"

# Markiere als installiert
echo "Markiere Installation als abgeschlossen..."
sudo touch ./.have_installed
echo "gpio:resistance:35:90:480:320" > ./.have_installed

# FBCP Installation (für Framebuffer Kopieren)
echo "Prüfe Internetverbindung für FBCP-Installation..."
wget --spider -q -o /dev/null --tries=1 -T 10 https://cmake.org/
if [ $? -eq 0 ]; then
    echo "Installiere FBCP-Abhängigkeiten..."
    sudo apt-get update
    sudo apt-get install cmake libraspberrypi-dev -y

    # Prüfe ob cmake installiert wurde
    type cmake > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "Installiere FBCP..."
        sudo rm -rf rpi-fbcp
        git clone https://github.com/tasanakorn/rpi-fbcp
        cd rpi-fbcp
        mkdir build
        cd build
        cmake ..
        make
        sudo install fbcp /usr/local/bin/fbcp
        cd ../..
        
        # Füge FBCP zum Autostart hinzu
        sudo sed -i 's/exit 0/fbcp \&\n\nexit 0/g' /etc/rc.local
    else
        echo "Fehler: cmake konnte nicht installiert werden"
    fi
else
    echo "Keine Internetverbindung verfügbar, überspringe FBCP-Installation"
fi

# Aktiviere SPI-Interface in DietPi
if command -v dietpi-config > /dev/null; then
    echo "Aktiviere SPI-Interface in DietPi..."
    sudo dietpi-config 2 5 spi on
fi

echo "Installation abgeschlossen. Bitte starten Sie das System neu mit 'sudo reboot'"
